<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final - Las Gemelas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-card { margin-bottom: 20px; }
        .result { margin-top: 10px; padding: 10px; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">üß™ Test Final - Las Gemelas</h1>
        
        <!-- Test 1: Conexi√≥n BD -->
        <div class="card test-card">
            <div class="card-header">
                <h5>1. Test Conexi√≥n Base de Datos</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-primary" onclick="testDB()">Probar Conexi√≥n BD</button>
                <div id="db-result" class="result" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Test 2: Rutas Disponibles -->
        <div class="card test-card">
            <div class="card-header">
                <h5>2. Test Rutas Disponibles</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-info" onclick="testRoutes()">Ver Rutas</button>
                <div id="routes-result" class="result" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Test 3: Registro Usuario -->
        <div class="card test-card">
            <div class="card-header">
                <h5>3. Test Registro Usuario</h5>
            </div>
            <div class="card-body">
                <button class="btn btn-success" onclick="testRegistro()">Registrar Usuario Test</button>
                <div id="registro-result" class="result" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Test 4: T√©cnicos -->
        <div class="card test-card">
            <div class="card-header">
                <h5>4. Test C√≥digos T√©cnicos</h5>
            </div>
            <div class="card-body">
                <input type="text" id="techCode" class="form-control mb-2" value="TECH_001" placeholder="C√≥digo t√©cnico">
                <button class="btn btn-warning me-2" onclick="testTecnicos()">Ver T√©cnicos</button>
                <button class="btn btn-danger" onclick="testUsuariosTech()">Ver Usuarios (T√©cnico)</button>
                <div id="tech-result" class="result" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Resultados Generales -->
        <div class="card">
            <div class="card-header">
                <h5>üìä Resumen de Pruebas</h5>
            </div>
            <div class="card-body">
                <div id="summary"></div>
            </div>
        </div>
    </div>

    <script>
        let testResults = {
            db: false,
            routes: false,
            registro: false,
            tecnicos: false
        };

        function updateSummary() {
            const summary = document.getElementById('summary');
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(r => r).length;
            
            summary.innerHTML = `
                <div class="progress mb-2">
                    <div class="progress-bar ${passed === total ? 'bg-success' : 'bg-warning'}" 
                         style="width: ${(passed/total)*100}%">
                        ${passed}/${total} pruebas pasadas
                    </div>
                </div>
                <small>
                    ${testResults.db ? '‚úÖ' : '‚ùå'} Base de Datos | 
                    ${testResults.routes ? '‚úÖ' : '‚ùå'} Rutas | 
                    ${testResults.registro ? '‚úÖ' : '‚ùå'} Registro | 
                    ${testResults.tecnicos ? '‚úÖ' : '‚ùå'} T√©cnicos
                </small>
            `;
        }

        async function testDB() {
            const resultDiv = document.getElementById('db-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'üîÑ Probando conexi√≥n...';
            
            try {
                const response = await fetch('/api/test-db');
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ‚úÖ <strong>Conexi√≥n exitosa</strong><br>
                        üìä Total usuarios: ${result.totalUsuarios}<br>
                        üè† Host: ${result.host}<br>
                        üìã Tabla usuarios: ${result.tablaUsuarios}
                    `;
                    testResults.db = true;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `‚ùå Error: ${result.error}`;
                    testResults.db = false;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå Error de conexi√≥n: ${error.message}`;
                testResults.db = false;
            }
            
            updateSummary();
        }

        async function testRoutes() {
            const resultDiv = document.getElementById('routes-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'üîÑ Obteniendo rutas...';
            
            try {
                const response = await fetch('/api/routes');
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    let html = '‚úÖ <strong>Rutas disponibles:</strong><br>';
                    
                    Object.keys(result.routes).forEach(category => {
                        html += `<br><strong>${category.toUpperCase()}:</strong><br>`;
                        result.routes[category].forEach(route => {
                            html += `‚Ä¢ ${route}<br>`;
                        });
                    });
                    
                    html += `<br><strong>C√≥digos t√©cnico:</strong> ${result.codigosTecnico.join(', ')}`;
                    resultDiv.innerHTML = html;
                    testResults.routes = true;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `‚ùå Error: ${result.error}`;
                    testResults.routes = false;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
                testResults.routes = false;
            }
            
            updateSummary();
        }

        async function testRegistro() {
            const resultDiv = document.getElementById('registro-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'üîÑ Registrando usuario test...';
            
            const timestamp = Date.now();
            const userData = {
                codigo: `U${timestamp}`,
                nombre: 'Test',
                apellido: 'Usuario',
                correo: `test${timestamp}@ejemplo.com`,
                contrasena: 'Test123@',
                telefono: '123456789',
                direccion: 'Direcci√≥n de prueba'
            };
            
            try {
                const response = await fetch('/api/registro', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(userData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ‚úÖ <strong>Usuario registrado exitosamente</strong><br>
                        üÜî ID: ${result.userId}<br>
                        üè∑Ô∏è C√≥digo: ${result.codigo}<br>
                        üìß Correo: ${userData.correo}
                    `;
                    testResults.registro = true;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `‚ùå Error: ${result.error}`;
                    testResults.registro = false;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
                testResults.registro = false;
            }
            
            updateSummary();
        }

        async function testTecnicos() {
            const resultDiv = document.getElementById('tech-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.innerHTML = 'üîÑ Verificando t√©cnicos...';
            
            try {
                const response = await fetch('/api/debug/tecnicos');
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    let html = '‚úÖ <strong>T√©cnicos disponibles:</strong><br>';
                    
                    result.data.forEach(tech => {
                        html += `‚Ä¢ <strong>${tech.codigo}</strong> - ${tech.nombre} (${tech.email}) - ${tech.activo ? 'Activo' : 'Inactivo'}<br>`;
                    });
                    
                    resultDiv.innerHTML = html;
                    testResults.tecnicos = true;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `‚ùå Error: ${result.error}`;
                    testResults.tecnicos = false;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
                testResults.tecnicos = false;
            }
            
            updateSummary();
        }

        async function testUsuariosTech() {
            const techCode = document.getElementById('techCode').value;
            const resultDiv = document.getElementById('tech-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.innerHTML = `üîÑ Obteniendo usuarios con c√≥digo ${techCode}...`;
            
            try {
                const response = await fetch(`/api/usuarios-tech?techCode=${techCode}`, {
                    headers: {
                        'x-tech-code': techCode
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `
                        ‚úÖ <strong>Acceso t√©cnico exitoso</strong><br>
                        üë• Total usuarios: ${result.stats.total}<br>
                        üìÖ Registros hoy: ${result.stats.hoy}<br>
                        üìä Esta semana: ${result.stats.semana}<br>
                        üìã Usuarios mostrados: ${result.usuarios.length}
                    `;
                    testResults.tecnicos = true;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = `‚ùå Error: ${result.error}`;
                    testResults.tecnicos = false;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `‚ùå Error: ${error.message}`;
                testResults.tecnicos = false;
            }
            
            updateSummary();
        }

        // Ejecutar tests autom√°ticamente al cargar
        window.onload = function() {
            updateSummary();
            setTimeout(() => {
                testDB();
                setTimeout(() => testRoutes(), 1000);
            }, 500);
        };
    </script>
</body>
</html>